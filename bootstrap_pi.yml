---
- hosts: pi
  remote_user: pi
  vars:
    temp_client_pubkey_file: "~/.ansible/tmp/temp_client_pubkey_file.pub"

  tasks:
    - name: generate ssh key if it doesn't exist
      user:
        name: pi
        generate_ssh_key: yes
        ssh_key_type: rsa
        ssh_key_bits: 2048

    - name: copy raspberry pi public ssh key to temp location
      fetch:
        dest: "{{ temp_client_pubkey_file }}"
        src: ~/.ssh/id_rsa.pub
        fail_on_missing: yes
        flat: yes

    - name: add local machine ssh key to authorized keys file
      authorized_key:
        key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
        user: pi

    - name: expand filesystem to fill sdcard
      command: raspi-config --expand-rootfs
      become: yes

    - name: reboot the pi
      shell: sleep 2 && shutdown -r now
      async: 1
      poll: 0
      ignore_errors: true
      become: yes
